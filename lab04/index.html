<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cumulative COVID-19 Case Rate per 10k People in WA (as of 2021-10-25)</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.5.0/mapbox-gl.js"></script>

  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }

    .map-overlay {
      position: absolute;
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(0,0,0,0.2);
      border-radius: 4px;
      font-family: Arial, sans-serif;
      z-index: 1;
      padding: 10px;
    }

    #features {
      top: 12px;
      left: 12px;
      width: 300px;
    }

    #legend {
      bottom: 12px;
      left: 12px;
      width: 220px;
      line-height: 20px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .legend-key {
      display: inline-block;
      width: 16px;
      height: 12px;
      margin-right: 6px;
      border-radius: 3px;
    }

    h2 { margin: 0 0 8px 0; font-size: 16px; }
    p { margin: 4px 0; font-size: 13px; }
  </style>
</head>

<body>
  <div id="map"></div>

  <!-- Info box -->
  <div id="features" class="map-overlay">
    <h2>Cumulative COVID-19 Case Rate (per 10k People)</h2>
    <div id="text-description">
      <p>Hover over a county to view its cumulative COVID-19 case rate.</p>
    </div>
    <p style="font-size: 11px; color: #444;">
      Data as of Oct 25, 2021 (rounded)
    </p>
  </div>

  <!-- Legend -->
  <div id="legend" class="map-overlay"></div>

  <script>
    mapboxgl.accessToken =
      'pk.eyJ1IjoibGlseS02MSIsImEiOiJjbWhlYXNnZXQwYnBmMm1vZXdremVqOWYxIn0.N5jV7WMsuC_28bUwXqxbUg';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v10',
      center: [-120.7401, 47.7511],
      zoom: 6
    });

    // County abbreviation dictionary (lowercase keys)
    const countyAbbr = {
      "adams": "ADM","asotin": "AST","benton": "BEN","chelan": "CHL",
      "clallam": "CLM","clark": "CLK","columbia": "COL","cowlitz": "COW",
      "douglas": "DGL","ferry": "FRY","franklin": "FRK","garfield": "GRF",
      "grant": "GRT","grays harbor": "GRH","island": "ISL","jefferson": "JEF",
      "king": "KNG","kitsap": "KIT","kittitas": "KTS","klickitat": "KLI",
      "lewis": "LEW","lincoln": "LNC","mason": "MSN","okanogan": "OKN",
      "pacific": "PAC","pend oreille": "PDO","pierce": "PCR","san juan": "SJ",
      "skagit": "SKG","skamania": "SKM","snohomish": "SNH","spokane": "SPK",
      "stevens": "STV","thurston": "THR","wahkiakum": "WHK","walla walla": "WLW",
      "whatcom": "WHT","whitman": "WTM","yakima": "YAK"
    };

    async function geojsonFetch() {
      const response = await fetch('assets/wa-covid-data-102521.geojson');
      const wa = await response.json();

      // Normalize county names & add abbreviations
      wa.features.forEach(f => {
        let clean = f.properties.name
          .toLowerCase()
          .replace(" county", "")
          .replace(" parish", "")
          .trim();

        f.properties.abbr = countyAbbr[clean] || "";
      });

      map.on('load', () => {
        map.addSource('wa-covid', {
          type: 'geojson',
          data: wa
        });

        // Choropleth layer
        map.addLayer({
          id: 'wa-covid-layer',
          type: 'fill',
          source: 'wa-covid',
          paint: {
            'fill-color': [
              'step', ['get', 'casePer10k'],
              '#fff5f0',
              300, '#fee0d2',
              600, '#fcbba1',
              900, '#fc9272',
              1200, '#fb6a4a',
              1500, '#de2d26',
              1800, '#a50f15'
            ],
            'fill-outline-color': '#555',
            'fill-opacity': 0.85,
            'fill-antialias': true
          }
        });

        // County abbreviation labels (non-duplicating)
        map.addLayer({
          id: 'county-labels',
          type: 'symbol',
          source: 'wa-covid',
          layout: {
            'text-field': ['get', 'abbr'],
            'text-size': 11,
            'symbol-placement': 'point',
            'text-allow-overlap': false,
            'text-ignore-placement': false
          },
          paint: {
            'text-color': '#444',
            'text-halo-color': '#ffffff',
            'text-halo-width': 1
          }
        });

        // Legend
        const layers = [
          '< 300','300–599','600–899','900–1199',
          '1200–1499','1500–1799','≥ 1800'
        ];
        const colors = [
          '#fff5f0','#fee0d2','#fcbba1','#fc9272',
          '#fb6a4a','#de2d26','#a50f15'
        ];

        const legend = document.getElementById('legend');
        legend.innerHTML =
          '<b>Cumulative COVID-19 Case Rate<br>(per 10k People)</b><br><br>';

        layers.forEach((label, i) => {
          const item = document.createElement('div');
          const key = document.createElement('span');
          key.className = 'legend-key';
          key.style.backgroundColor = colors[i];

          const value = document.createElement('span');
          value.innerHTML = label;

          item.appendChild(key);
          item.appendChild(value);
          legend.appendChild(item);
        });

        // Hover interaction
        map.on('mousemove', ({ point }) => {
          const county = map.queryRenderedFeatures(point, { layers: ['wa-covid-layer'] });
          const info = document.getElementById('text-description');

          if (county.length > 0) {
            const p = county[0].properties;
            info.innerHTML = `
              <h3>${p.name} (${p.abbr})</h3>
              <p><strong>Cumulative case rate:</strong> ${p.casePer10k} per 10k people</p>
            `;
          } else {
            info.innerHTML =
              '<p>Hover over a county to view its cumulative COVID-19 case rate.</p>';
          }
        });

      });
    }

    geojsonFetch();
  </script>
</body>
</html>
